<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
        
    
    <meta property="og:site_name" content="Monsanto Engineering Blog" />
    <meta property="og:title" content="Secret STDIN Slurper" />
    <meta property="og:description" content="The dangers of using STDIN to drive a BASH loop" />
    <meta property="og:url" content="http://engineering.monsanto.com/2015/05/27/secret-stdin-slurper/" />
    <meta property="og:image" content="http://engineering.monsanto.com/img/mon-city_garden.jpg" />
    <meta name="description" content="The dangers of using STDIN to drive a BASH loop" />
    

    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Secret STDIN Slurper - Engineering at Monsanto</title>

    <link rel="canonical" href="http://engineering.monsanto.com/2015/05/27/secret-stdin-slurper/" />

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.min.css" />
    <link rel="stylesheet" href="/css/scala-colors.min.css" />

    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Engineering at Monsanto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/code/">Code</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/mon-city_garden.jpg')">
    <div class="heading-underlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Secret STDIN Slurper</h1>
                        
                        <h2 class="subheading">The dangers of using STDIN to drive a BASH loop</h2>
                        
                        <span class="meta">Posted  by David Dooling on May 27, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-body">

				<p><a href="http://www.gnu.org/software/bash/">BASH</a> may be looked down upon by
all the programming language hipsters out there, but when you are
doing system-level tasks it can be quite convenient: it&#39;s on every
system, it has no dependencies to install, and it can be a powerful
language when used properly.</p>

<h2>The Setup</h2>

<p>As mentioned in a
<a href="http://engineering.monsanto.com/2015/05/22/jq-change-json/">previous post</a>,
we use <a href="http://aws.amazon.com/cloudformation/">AWS CloudFormation</a> to
stand up infrastructure in AWS in an automated way.  In one use case,
we create a standard environment that makes it easy to deploy
microservices as <a href="https://www.docker.com/">Docker</a> containers onto an
<a href="http://aws.amazon.com/autoscaling/">Auto Scaling</a> group running
<a href="https://coreos.com/">CoreOS</a>.  If there is a container you want to
run on every container, e.g., a log forwarder, you can simply put the
<a href="http://www.freedesktop.org/wiki/Software/systemd/">systemd</a> unit
information in the
<a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/user-data.html">instance User Data</a>
of the Auto Scaling group&#39;s Launch Configuration in
<a href="https://coreos.com/docs/cluster-management/setup/cloudinit-cloud-config/">cloud-config</a>
format.</p>

<p>Things are a bit trickier if you only want to run a container on a
subset of the instances.  You would typically do this with a scheduler
like
<a href="https://coreos.com/docs/launching-containers/launching/launching-containers-fleet/">fleet</a>
or <a href="http://mesos.apache.org/">Mesos</a>.  If the container is one of your
microservices, you can just configure deployment in your continuous
integration server, e.g., <a href="https://jenkins-ci.org/">Jenkins</a>.  If,
however, the container is more of an infrastructure service that you
only want running on a single node, something like
<a href="https://www.elastic.co/products/kibana">Kibana</a> for a system
dashboard, you need to find a different way to inject that container
into your scheduler.</p>

<p>As a first pass, we decided to have the helper BASH script we use to
spin up and manage state of our CloudFormation stacks simply wait for
the stack creation to complete and then issue fleet commands via SSH.
Alongside the template used to create the stack, we created a file
that contained the list of unit files we wanted the script to spin up.
So if our template is called <code>vpc-default.json</code>, then we would create
a file called <code>vpc-default.services</code> with contents something like
this:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">kibana
route-updater
reaper
</code></pre></div>
<p>After the stack creation was complete, the script would read this file
and issue the appropriate fleet commands over SSH on one of the nodes
in the fleet cluster.</p>

<h2>The Problem</h2>

<p>One of our engineers initially coded up the solution something like
this:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">services_file</span><span class="o">=</span><span class="s2">&quot;vpc-default.services&quot;</span>
<span class="k">while</span> <span class="nb">read </span>service<span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;launching service: $service&quot;</span>
    <span class="k">if</span> ! ssh service fleetctl submit <span class="nv">$service</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;ERROR: failed to submit service: $service&quot;</span>
        <span class="k">return</span> 1
    <span class="k">fi</span>
    <span class="k">if</span> ! ssh service fleetctl start <span class="nv">$service</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;ERROR: failed to submit service: $service&quot;</span>
        <span class="k">return</span> 1
    <span class="k">fi</span>
    <span class="nb">echo</span> <span class="s2">&quot;successfully launched service: $service&quot;</span>
<span class="k">done</span> &lt; <span class="s2">&quot;$services_file&quot;</span></code></pre></div>

<p>After setting the value of the variable <code>services_file</code> to the name of
the services file (in the actual script this is done dynamically), the
execution enters a <code>while</code> loop.  Each time through the <code>while</code> loop,
it <code>read</code>&#39;s a line from STDIN and puts what is read into the variable
<code>service</code>.  But we don&#39;t want the values read from <code>STDIN</code>, we want
them read from the file, so we redirect <code>STDIN</code> to come from
<code>$services_file</code>, that&#39;s the <code>&lt; &quot;$services_file&quot;</code> on the last line.</p>

<p>Unfortunately, this doesn&#39;t work.  When we run the script on a file
with the contents show above, all we get is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">launching service: kibana
successfully launched service: kibana
</code></pre></div>
<p>The loop only executes one time instead of three!?!  What is going on?
Why is the loop terminating early and/or what happens to the second
and third line of the file?</p>

<p>To try to figure this out, let&#39;s simplify the script.  Let&#39;s just echo
the each line as we read it:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">services_file</span><span class="o">=</span><span class="s2">&quot;vpc-default.services&quot;</span>
<span class="k">while</span> <span class="nb">read </span>service<span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;service:$service&quot;</span>
<span class="k">done</span> &lt; <span class="s2">&quot;$services_file&quot;</span></code></pre></div>

<p>When we run this, we get:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">service:kibana
service:route-updater
service:reaper
</code></pre></div>
<p>as expected.  Something must be going wrong inside our original loop,
but what could it be?  We know running <code>echo</code> is OK, so the problem
must be with the SSH fleet commands.  Somehow, they are causing the
loop to exit without processing the last two lines of the file.  So
either they are making reading the second line evaluate to false,
which seems unlikely, or those commands are somehow consuming the
contents of <code>STDIN</code> themselves.  We can see if the latter is a possibility
by replacing the SSH commands with a simpler command that consumes
<code>STDIN</code>, <code>cat</code>:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">services_file</span><span class="o">=</span><span class="s2">&quot;vpc-default.services&quot;</span>
<span class="k">while</span> <span class="nb">read </span>service<span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;service:$service&quot;</span>
    cat
<span class="k">done</span> &lt; <span class="s2">&quot;$services_file&quot;</span></code></pre></div>

<p>When you run the above bit of code, the output is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">service:kibana
route-updater
reaper
</code></pre></div>
<p>Ah-ha! The <code>while</code> loop <code>read</code> gobbles up the the first line of the
file, but then the <code>cat</code> within the loop consumes the rest of the file
and the next time through the loop, <code>read</code> returns false and the
script moves along.  But does the same thing happens with SSH?  We can
try that too:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">services_file</span><span class="o">=</span><span class="s2">&quot;vpc-default.services&quot;</span>
<span class="k">while</span> <span class="nb">read </span>service<span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;ssh service:$service&quot;</span>
    ssh service cat
<span class="k">done</span> &lt; <span class="s2">&quot;$services_file&quot;</span></code></pre></div>

<p>Running this outputs:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">ssh service:kibana
route-updater
reaper
</code></pre></div>
<p>So SSH is indeed consuming the contents of <code>STDIN</code>.  How?  Basically,
SSH connects the <code>STDIN</code> of the calling process to the <code>STDIN</code> of the
process on the remote machine so you can do cool things like pipe
stuff over SSH.  If the remote process does something with <code>STDIN</code>,
like <code>cat</code> above, great.  If it just ignores <code>STDIN</code> like the fleet
commands, then lines two through the end of the file get lost
somewhere on the remote machine.</p>

<h2>The Solution</h2>

<p>The solution to this problem is quite simple and good advice whenever
writing loops in BASH: read the contents of the file into a variable
before the loop ever executes and use a <code>for</code> loop instead of a
<code>while</code> loop.  This looks something like:</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="nv">services_file</span><span class="o">=</span><span class="s2">&quot;vpc-default.services&quot;</span>
<span class="nv">services</span><span class="o">=</span><span class="k">$(</span>&lt; <span class="s2">&quot;$services_file&quot;</span><span class="k">)</span>
<span class="k">for</span> service in <span class="nv">$services</span><span class="p">;</span> <span class="k">do</span>
    <span class="nb">echo</span> <span class="s2">&quot;launching service: $service&quot;</span>
    <span class="k">if</span> ! ssh service fleetctl submit <span class="nv">$service</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;ERROR: failed to submit service: $service&quot;</span>
        <span class="k">return</span> 1
    <span class="k">fi</span>
    <span class="k">if</span> ! ssh service fleetctl start <span class="nv">$service</span><span class="p">;</span> <span class="k">then</span>
        <span class="nb">echo</span> <span class="s2">&quot;ERROR: failed to submit service: $service&quot;</span>
        <span class="k">return</span> 1
    <span class="k">fi</span>
    <span class="nb">echo</span> <span class="s2">&quot;successfully launched service: $service&quot;</span>
<span class="k">done</span></code></pre></div>

<p>When you run this, you get the expected output:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">launching service: kibana
successfully launched service: kibana
launching service: route-updater
successfully launched service: route-updater
launching service: reaper
successfully launched service: reaper
</code></pre></div>
<p>Then, fleet will make sure your services are running and all is right
with the world.  What happens if you need to read a very large file
where the act of doing so will cause harm to the normal operations of
your computer?  You may want to investigate the SSH <code>-n</code> command line
option.</p>


                

                        <div class="post-signature multiple">
                            posted on May 27, 2015 by <br>
                        


                            <div class="author">
                                
                                <img src="https://avatars1.githubusercontent.com/u/57881?v=3&s=40">
                                
                                    <span>
                                        David Dooling
                                    </span>

                                
                                <a  href="https://twitter.com/ddgenome">
                                    <i class="fa fa-twitter fa-1x "></i>
                                </a>
                                
                                
                                <a  href="https://www.github.com/ddgenome">
                                    <i class="fa fa-github fa-1x"></i>
                                </a>
                                
                            </div>
                        
                        </div>
                

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/05/22/jq-change-json/" data-toggle="tooltip" data-placement="top" title="Modifying JSON on the command line">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/06/12/etcd-clustering/" data-toggle="tooltip" data-placement="top" title="etcd Clustering in AWS">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/MonPlatformEng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.youtube.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-square fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; 2015 Engineering at Monsanto &nbsp;|&nbsp; Built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a><br />
                    <a href="/sitemap.xml">Sitemap</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/legal-notice/Pages/default.aspx">Legal Notice</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/privacy-policy/Pages/default.aspx">Privacy Policy</a> &nbsp;|&nbsp;
                    <a href="/contact">Contact Us</a>

                    </p>
                <div align="center"><br /><img src="/img/Monsanto_logo.jpg" width="170" height="54" border="0" /></div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<!-- Google Analytics JavaScript -->

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43186905-16', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

    var trackOutboundLink = function(url) {
        ga('send', 'event', 'outbound', 'click', url, {'hitCallback':
                function () {
                    document.location = url;
                }
        });
    }
</script>
<script src="/js/main.js"></script>


</body>

</html>
