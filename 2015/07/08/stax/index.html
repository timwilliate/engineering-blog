<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
        
    
    <meta property="og:site_name" content="Monsanto Engineering Blog" />
    <meta property="og:title" content="Stax" />
    <meta property="og:description" content="Create and manage CloudFormation stacks in AWS" />
    <meta property="og:url" content="http://engineering.monsanto.com/2015/07/08/stax/" />
    <meta property="og:image" content="http://engineering.monsanto.com/img/mon-field_rows.jpg" />
    <meta name="description" content="Create and manage CloudFormation stacks in AWS" />
    
    <meta name="author" content="Phil Cryer" />
    

    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Stax - Engineering at Monsanto</title>

    <link rel="canonical" href="http://engineering.monsanto.com/2015/07/08/stax/" />

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.min.css" />
    <link rel="stylesheet" href="/css/scala-colors.min.css" />

    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Engineering at Monsanto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/code/">Code</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/mon-field_rows.jpg')">
    <div class="heading-underlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Stax</h1>
                        
                        <h2 class="subheading">Create and manage CloudFormation stacks in AWS</h2>
                        
                        <span class="meta">Posted by Phil Cryer on July 8, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-body">

				<p>When we were looking to build out an infrastructure in AWS (<a href="https://aws.amazon.com">Amazon Web Services</a>), we took some time to understand how the <a href="https://github.com/aws/aws-cli">aws-cli</a> (Universal Command Line Interface for Amazon Web Services) worked. With ideas from other projects found on <a href="https://github.com">GitHub</a>, we started wrapping commands in simple BASH scripts, and pointed it to CloudFormation templates written in JSON. From there <a href="https://github.com/monsantoco/stax">stax</a> was born, and we have released it as open source under the <a href="http://opensource.org/licenses/BSD-3-Clause">BSD 3-clause license</a>.</p>

<p>It’s easy to get started with stax to create and manage CloudFormation stacks (aka stax) in AWS (<a href="https://aws.amazon.com">Amazon Web Services</a>) and the project provides several CloudFormation templates, or you can use your own.</p>

<p>For launching new AWS instances with stax, you can use Linux (Debian GNU/Linux 7 and Ubuntu 14.04 are supported) and Apple OS X (tested on 10.10 and 10.9). When running with a default template, you will end up with a VPC setup like the following:</p>

<p><img src="/img/aws-stax.png" alt="AWS Stax Diagram"></p>

<p><strong>NOTICE:</strong> <em>As you can see, stax creates an AWS environment from scratch, so it needs to be run under an IAM user or role with permissions to create all AWS resources in your template, including potentially IAM roles. You should understand the risk associated with giving users these permissions in your AWS account before using stax.</em></p>

<p>CoreOS hosts run Docker containers on the Gateway and Service layer, while <a href="https://aws.amazon.com/amazon-linux-ami/">Amazon Linux</a> instances serve as NAT devices to direct traffic for the internal hosts. Additionally, one of the biggest requests we had was to simplify the connectivity to nodes once the stax was created. For this we have the <code>stax connect</code> function, that will ssh through the bastion/ssh host, and log you on to either a host on the gateway layer, or the services layer.</p>

<p>The Gateway layer:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ./stax connect gateway
     _
    | | every cloud has a silicon lining
 ___| |_ __ ___  __
/ __| __/ _` \ \/ /
\__ \ || (_| |&gt;  &lt;
|___/\__\__,_/_/\_\  0.9

[ ---- ]  checking if stax build is complete
[ ---- ]  describe stax
[ NAME ]  vpc-stax-42179-unrepulsed
[ ---- ]    querying aws
[ ---- ]    query complete
[ ---- ]    see /home/phil/devel/stax/run/vpc-stax-42179-unrepulsed.json for details
[ ---- ]    stack vpc-stax-42179-unrepulsed build complete
[ ---- ]  getting public IP (EIP)
[ ---- ]    public IP (EIP): 52.6.248.224
[ ---- ]    writing to /home/phil/devel/stax/run/vpc-stax-42179-unrepulsed.bastion
[ ---- ]  get gateway and service IPs
[ ---- ]    querying aws for gateway hosts
[ ---- ]    getting service leaders
[ ---- ]    querying aws for service hosts
[ ---- ]  creating ssh_config
[ ---- ]    writing /home/phil/devel/stax/run/vpc-stax-42179-unrepulsed.ssh_config
[ ---- ]    created /home/phil/devel/stax/run/vpc-stax-42179-unrepulsed.ssh_config
[ ---- ]  connecting to stax: gateway
Last login: Tue Apr 28 18:57:07 2015 from 10.183.1.208
CoreOS stable (633.1.0)
core@ip-10-183-0-131 ~ $
</code></pre></div>
<p>So you’re logged into a gateway CoreOS box, and from the current <code>/etc/motd</code> you can see what version of CoreOS you are running.</p>

<p>Now we’ll login to the Service layer:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ./stax connect service
     _
    | | all glory to the hypnotoad!
 ___| |_ __ ___  __
/ __| __/ _` \ \/ /
\__ \ || (_| |&gt;  &lt;
|___/\__\__,_/_/\_\  0.9

[ ---- ]  checking if stax build is complete
[ ---- ]  describe stax
[ NAME ]  vpc-stax-42179-unrepulsed
[ ---- ]    querying aws
[ ---- ]    query complete
[ ---- ]    see /home/phil/devel/stax/run/vpc-stax-42179-unrepulsed.json for details
[ ---- ]    stack vpc-stax-42179-unrepulsed build complete
[ ---- ]  connecting to stax: service
CoreOS stable (633.1.0)
core@ip-10-183-0-111 ~ $
</code></pre></div>
<p>Keeping in mind that this is only available when you’re in development, no external access is allowed to internal nodes directly without the bastion/ssh host, and shutting it down when running in production is highly recommended.</p>

<p>Lastly a quick run of stax without arguments will show you the usage, giving you an idea of all lf the tasks the tool is capable of:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">$ ./stax
Usage: stax [OPTIONS] COMMAND

Options:
  -c,--config=CONFIG       Use file CONFIG rather than config/vpc-default.json
  -d,--debug               Turn on verbose messages
  -h,--help                Output this message
  -j,--jump=IP             SSH through host with IP address IP
  -m,--module=MOD          Use config/MOD.json and template/MOD.json
  -t,--template=TEMPLATE   Use file TEMPLATE rather than template/vpc-default.json
  -v,--version             Print name and version information
  -y,--yes                 Do not prompt for confirmation

If an argument is required for a long option, so to the short. Same for
optional arguments.

Commands:
  add                Add functionality to an existing VPC
  check              Run various tests against an existing stax
  connect [TARGET]   Connect to bastion|gateway|service in the VPC stax over SSH
  create             Create a new VPC stax in AWS
  describe           Describe the stax created from this host
  delete             Delete the existing VPC stax
  dockerip-update    Fetch docker IP addresses and update related files
  fleet              Run various fleetctl commands against the fleet cluster
  help               Output this message
  history            View history of recently created/deleted stax
  list               List all completely built and running stax
  rds PASSWORD       Create an RDS instance in the DB subnet
  rds-delete RDSIN   Delete RDS instance RDSIN
  remove ADD         Remove the previously added ADD
  services           List servers that are available to run across a stax
  start SERVICE      Start service SERVICE in the fleet cluster
  test               Automated test to exercise functionality of stax
  validate           Validate CloudFormation template

For more help, check the docs: https://github.com/MonsantoCo/stax
</code></pre></div>
<p>To try it out, just clone the repo and follow the documentation in the readme.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">git clone https://github.com/MonsantoCo/stax
more stax/README.md
</code></pre></div>
<p>We hope that this tool will be useful to the community and look forward to feedback on what people think of it. We’re open to issues you might create or pull requests to make stax better.</p>

                

                    <div class="post-signature">
                        
                            <img src="https://avatars0.githubusercontent.com/u/43070?v=3&s=40">
                        
                        <span>
                            Phil Cryer posted on July 8, 2015
                        </span>

                            
                            <a  href="https://twitter.com/fak3r">
                                <i class="fa fa-twitter fa-1x "></i>
                            </a>
                            
                            
                            <a  href="https://www.github.com/philcryer">
                                <i class="fa fa-github fa-1x"></i>
                            </a>
                            


                    </div>
                

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/06/17/docker-metrics/" data-toggle="tooltip" data-placement="top" title="Doing Docker Metrics">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/07/10/cloudformation-template-generator/" data-toggle="tooltip" data-placement="top" title="CloudFormation Template Generator">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/MonPlatformEng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.youtube.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-square fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; 2015 Engineering at Monsanto &nbsp;|&nbsp; Built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a><br />
                    <a href="/sitemap.xml">Sitemap</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/legal-notice/Pages/default.aspx">Legal Notice</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/privacy-policy/Pages/default.aspx">Privacy Policy</a> &nbsp;|&nbsp;
                    <a href="/contact">Contact Us</a>

                    </p>
                <div align="center"><br /><img src="/img/Monsanto_logo.jpg" width="170" height="54" border="0" /></div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<!-- Google Analytics JavaScript -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43186905-16', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
</script>
<script src="/js/main.js"></script>


</body>

</html>
