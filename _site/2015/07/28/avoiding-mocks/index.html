<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    
        
    
    <meta property="og:site_name" content="Monsanto Engineering Blog" />
    <meta property="og:title" content="Testing without mocking in Scala" />
    <meta property="og:description" content="Mocking works well for testing in Java, but can we do better in Scala?" />
    <meta property="og:url" content="http://engineering.monsanto.com/2015/07/28/avoiding-mocks/" />
    <meta property="og:image" content="/img/mon-field_rows.jpg" />
    <meta name="description" content="Mocking works well for testing in Java, but can we do better in Scala?" />
    
    <meta name="author" content="Jessica Kerr" />
    

    <link rel="shortcut icon" href="/favicon.ico" />

    <title>Testing without mocking in Scala - Engineering at Monsanto</title>

    <link rel="canonical" href="http://engineering.monsanto.com/2015/07/28/avoiding-mocks/" />

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/clean-blog.min.css" />
    <link rel="stylesheet" href="/css/scala-colors.min.css" />

    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css" />

    <!-- Custom Fonts -->
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>


<body>

    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Engineering at Monsanto</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="/">Home</a>
                </li>
                
                <li>
                    <a href="/about/">About</a>
                </li>
                
                <li>
                    <a href="/code/">Code</a>
                </li>
                
                <li>
                    <a href="/contact/">Contact</a>
                </li>
                
            </ul>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>


    <!-- Post Header -->
<header class="intro-header" style="background-image: url('/img/mon-field_rows.jpg')">
    <div class="heading-underlay">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                    <div class="post-heading">
                        <h1>Testing without mocking in Scala</h1>
                        
                        <span class="meta">Posted by Jessica Kerr on July 28, 2015</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1 post-body">

				<style scoped>
  .interface { color: #D907E8 }
  .logic { color: #19BEFF }
  .jsonClient {color: #E80D0C }
  .functionParam {color: #1ab955 }
  .port {color: #FF9C00 }
  .pass {color: #D907E8 }
</style>

<p>For unit testing in Java, mocking frameworks replace classes necessary for the code under 
test, but not under test themselves. These mock frameworks don&#39;t transfer easily to Scala. That&#39;s OK: the functional side of Scala can make mocking unnecessary. As someone told me the other day at 
<a href="http://polyconf.com">PolyConf</a>: mocks are the sound of your code crying out, &quot;please structure me differently!&quot;</p>

<p>Don&#39;t use mocks? Structure code differently? Easier said than done. What follows is a practical example of removing the need for a mock object, and at the same time separating concerns of interface and business logic.</p>

<p>Say there&#39;s an IdentityService that returns a username based on an access token. Internally, it calls out to AccessTokenService, retrieving
information about the access token. Then it interprets the result: success provides an identity; anything else means proceed 
anonymously (return no identity). The code looks like:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
class IdentityClient(<span class="jsonClient">jsonClient: JsonClient</span>)  {

  def fetchIdentity(accessToken: String) : Future[Option[Identity]] = {
    <span class="jsonClient">jsonClient</span><span class="interface">.getWithoutSession(</span>
      <span class="interface">Path("identities"),</span>
      <span class="interface">Params("access_token" -> </span>accessToken<span class="interface">)</span>
    <span class="interface">)</span>.map <span class="logic">{
      case JsonResponse(OkStatus, json, _, _) => Some(Identity.from(json))
      case _ => None
    }</span>
  }
}</code></pre></div>

<p>The tests want to say, &quot;If the inner call returns success, provide the returned identity; if it fails, return none.&quot; To unit-test that, we need to mock the <span class="jsonClient">JsonClient</span>, and its getWithoutSession method, and check the arguments... ugh, mocking.</p>

<p>The secret here is to recognize that part of the method under test is about the <span class="interface">interface</span>, and part of it is <span class="logic">business logic</span>.</p>

<p>The <span class="interface">interface</span> is only testable in integration tests. That&#39;s where we check our assumptions about the path structure, the input and the output of the other service. 
The <span class="logic">business logic</span> part of this is unit-testable once we separate the two.</p>

<h1>Ports and Adapters</h1>

<p>Instead of passing in a general <span class="jsonClient">JsonClient</span>,
 let&#39;s pass in <span class="functionParam">a function</span> that contains all the interface code. That function needs an access token, and it returns a future response.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
class IdentityClient(<span class="port">howToCheck: String => Future[JsonResponse]</span>) {

  def fetchIdentity(accessToken: String) : Future[Option[Identity]] = {
    <span class="port">howToCheck</span>(accessToken).map <span class="logic">{</span>
      <span class="logic">case JsonResponse(OkStatus, json, _, _) => Some(IdentityMapper(json))</span>
      <span class="logic">case _ => None</span>
    <span class="logic">}</span>
  }
}
</code></pre></div>

<p>Meanwhile, the real <span class="interface">interface code</span> is shipped off to a handy object somewhere:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
object RealAccessTokenService {
  def reallyCheckAccessToken(<span class="jsonClient">jsonClient:JsonClient</span>)(accessToken: String): Future[JsonResponse] = 
    <span class="jsonClient">jsonClient</span><span class="interface">.getWithoutSession(</span>
    <span class="interface">Path() / "identity",</span>
    <span class="interface">Params("access_token" -> accessToken)</span>
  <span class="interface">)</span>
}
</code></pre></div>

<p>The production code can instantiate the AccessToken client using that object, but the test is free to provide <span class="functionParam">a fake function implementation</span>, without duplicating any specifics about this particular interface:</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
it("returns an Identity when we have it") {
  val jsonBody = Map("identity" -> Map("id" -> "external_username")).toJson
  val identityClient 
    = new IdentityClient(<span class="functionParam">_ => Future(JsonResponse(OkStatus, jsonBody))</span>)

  Await.result(identityClient.fetchIdentity("an_access_token"), 1.second) ===
    Some(Identity("external_username"))
}
</code></pre></div>

<p>This test constructs the expected response and then provides <span class="functionParam">a function</span> that returns that, no matter what. 
It isn&#39;t checking the arguments, although it could. We can pass a function that does whatever we want, for the purposes of our test.
 There&#39;s no <span class="jsonClient">JsonClient</span> object to mock. (Technically, <span class="functionParam">the function we passed</span> is a fake, which is different from a mock. It works here.)</p>

<p>This is a minimal example, and the test isn&#39;t perfect. Yet, it shows how passing a &quot;<span class="functionParam">how</span>&quot; instead of passing <span class="jsonClient">an object</span> can make testing easier in Scala. Check the sample code <a href="https://github.com/MonsantoCo/engineering-blog/blob/testing-without-mocking-example-1/examples/testing-without-mocking/src/test/scala/com/monsanto/engineering_blog/testing_without_mocking/IdentityClientTest.scala">before</a> 
and <a href="https://github.com/MonsantoCo/engineering-blog/blob/testing-without-mocking-example-2/examples/testing-without-mocking/src/test/scala/com/monsanto/engineering_blog/testing_without_mocking/IdentityClientTest.scala">after</a> to see the difference.</p>

<p>This example illustrates a ports-and-adapters architecture. By removing the interface code, we created a <span class="port">port</span> -- like a hole, like a Java interface. Then the RealJsonClient contains an <span class="functionParam">adapter</span>:
 a plug for the hole that hooks up to a real-life system. The function passed in the test is an <span class="functionParam">adapter</span> that fits the same hole.</p>

<h1>Or: Flow of Data</h1>

<p>The ports-and-adapters style lets us drop in different implementations for I/O that happens in the middle of our code. If we can avoid I/O in the middle of the code, even better.</p>

<p>There&#39;s a cleaner way of restructuring this same code, because it&#39;s possible to view it as: gather data, then make decisions, then output.</p>

<p><img src="/img/flow-of-data.png" alt="input, transformation, output"></p>

<p>Instead of passing in <span class="port">how</span> to call the AccessTokenService, why not make the call and <span class="pass">pass the results</span> into the function under test?</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
object dentityClient  {
  def fetchIdentity(<span class="pass">accessTokenInfo: Future[JsonResponse]</span>) : Future[Option[dentity]] = {
   <span class="logic">accessTokenInfo.map {</span>
      <span class="logic">case JsonResponse(OkStatus, json) => Some(Identity.from(json)){</span>
      <span class="logic">case _ => None{</span>
    <span class="logic">}</span>
  }
}
</code></pre></div>

<p>The function is data-in, data-out. No need to instantiate a class; an object will do. The code is even easier to test now. No mocks, no fakes, construct some input and <span class="pass">pass it in</span>.</p>

<div class="highlight"><pre><code class="language-scala" data-lang="scala">
import dentityClient._

it("returns an Identity when we have it") {
  val jsonBody = Map("identity" -> Map("id" -> "external_username")).toJson
  val accessTokenInfo = Future(JsonResponse(OkStatus, jsonBody))

  Await.result(fetchIdentity(<span class="pass">accessTokenInfo</span>), 1.second) ===
  Some(Identity("external_username"))
}
</code></pre></div>

<p>In the real world, we use the same RealAccessTokenService to gather the input before calling 
our data-in, data-out function. Instead of passing &quot;how to gather input&quot; we&#39;re passing <span class="pass">the input</span> as data. This is the simplest structure. Sample code <a href="https://github.com/MonsantoCo/engineering-blog/blob/testing-without-mocking-example-3/examples/testing-without-mocking/src/test/scala/com/monsanto/engineering_blog/testing_without_mocking/IdentityClientTest.scala">here</a>.</p>

<p>Whenever you see mocking in Scala, look for an opportunity to separate <span class="logic">decision-making code</span> from <span class="interface">interface code</span>. Consider these styles instead.</p>

<p>Thanks to <a href="https://twitter.com/starkcoffee">Duana</a> for asking me these questions and providing the example.</p>

                

                    <div class="post-signature">
                        
                            <img src="/img/placeholder.jpg">
                        
                        <span>
                            Jessica Kerr posted on July 28, 2015
                        </span>

                            
                            <a  href="https://twitter.com/jessitron">
                                <i class="fa fa-twitter fa-1x "></i>
                            </a>
                            
                            
                            <a  href="https://www.github.com/jessitron">
                                <i class="fa fa-github fa-1x"></i>
                            </a>
                            


                    </div>
                

                <hr>

                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2015/07/22/building-an-open-source-cloud-foundry-toolbox/" data-toggle="tooltip" data-placement="top" title="PaaSify your Apps">&larr; Previous Post</a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2015/07/29/cf-portal/" data-toggle="tooltip" data-placement="top" title="Cloud Foundry Portal">Next Post &rarr;</a>
                    </li>
                    
                </ul>

            </div>
        </div>
    </div>
</article>

<hr>


    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="https://twitter.com/MonPlatformEng">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.youtube.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-youtube-square fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://www.facebook.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    
                    <li>
                        <a href="https://github.com/MonsantoCo">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                    
                    <li>
                        <a href="/feed.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <p class="copyright text-muted">Copyright &copy; 2015 Engineering at Monsanto &nbsp;|&nbsp; Built with <a href="http://jekyllrb.com/">Jekyll</a> and hosted on <a href="https://pages.github.com/">GitHub Pages</a><br />
                    <a href="/sitemap.xml">Sitemap</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/legal-notice/Pages/default.aspx">Legal Notice</a> &nbsp;|&nbsp;
                    <a href="http://www.monsanto.com/privacy-policy/Pages/default.aspx">Privacy Policy</a> &nbsp;|&nbsp;
                    <a href="/contact">Contact Us</a>

                    </p>
                <div align="center"><br /><img src="/img/Monsanto_logo.jpg" width="170" height="54" border="0" /></div>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/clean-blog.min.js "></script>

<!-- Google Analytics JavaScript -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
              })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-43186905-16', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');
</script>
<script src="/js/main.js"></script>


</body>

</html>
